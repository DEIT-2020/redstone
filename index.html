<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Bloodless by luizmineo</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Bloodless</h1>
        <p>A metadata driven microframework for Dart.</p>

        <p class="view"><a href="https://github.com/luizmineo/bloodless">View the Project on GitHub <small>luizmineo/bloodless</small></a></p>


        <ul>
          <li><a href="https://github.com/luizmineo/bloodless/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/luizmineo/bloodless/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/luizmineo/bloodless">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>Bloodless is a simple server-side microframework for Dart.</p>

<div class="highlight highlight-dart"><pre>
<span class="k">import</span> <span class="s1">'package:bloodless/server.dart'</span> <span class="k">as</span> <span class="n">app</span><span class="p">;</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="n">helloWorld</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">"Hello, World!"</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">app</span><span class="p">.</span><span class="n">setupConsoleLog</span><span class="p">();</span>
  <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>

</pre></div>

<pre><code>$ dart hello.dart 
INFO: 2014-02-24 13:16:19.086: Configured target for / : .helloWorld
INFO: 2014-02-24 13:16:19.102: Setting up VirtualDirectory for /home/user/project/web - followLinks: false - jailRoot: true - index files: [index.html]
INFO: 2014-02-24 13:16:19.121: Running on 0.0.0.0:8080
</code></pre>

<p><strong>NOTE: Bloodless took a lot of ideas and concepts from the Python's <a href="http://flask.pocoo.org/">Flask</a> microframework</strong></p>

<h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<ul>
<li>Create a new Dart package (<a href="http://pub.dartlang.org/doc/">manually</a> or through Dart Editor)</li>
<li>Add bloodless as a dependency in <code>pubspec.yaml</code> file</li>
</ul><pre><code>name: my_app
 dependencies:
   bloodless: any
</code></pre>

<ul>
<li>Run <code>pub get</code> to update dependencies</li>
<li>Create a <code>bin</code> directory</li>
<li>Create a <code>server.dart</code> file under the <code>bin</code> directory</li>
</ul><div class="highlight highlight-dart"><pre>
<span class="k">import</span> <span class="s1">'package:bloodless/server.dart'</span> <span class="k">as</span> <span class="n">app</span><span class="p">;</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="n">helloWorld</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">"Hello, World!"</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">app</span><span class="p">.</span><span class="n">setupConsoleLog</span><span class="p">();</span>
  <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>

</pre></div>

<ul>
<li>To run the server, create a launch configuration in Dart Editor, or use the <code>dart</code> command:</li>
</ul><pre><code>$ dart bin/server.dart
INFO: 2014-02-24 13:16:19.086: Configured target for / : .helloWorld
INFO: 2014-02-24 13:16:19.102: Setting up VirtualDirectory for /home/user/project/web - followLinks: false - jailRoot: true - index files: [index.html]
INFO: 2014-02-24 13:16:19.121: Running on 0.0.0.0:8080
</code></pre>

<ul>
<li>Now head over to <a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a>, and you should see your hello world greeting.</li>
</ul><h2>
<a name="routing" class="anchor" href="#routing"><span class="octicon octicon-link"></span></a>Routing</h2>

<p>Just use the <code>Route</code> annotation to bind a method with a URL:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="n">helloWorld</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">"Hello, World!"</span><span class="p">;</span>
</pre></div>

<p>The returned value will be serialized to the client according to its type. For example, if the value is a String, the client will receive a <em>text/plain</em> response.</p>

<table>
<thead><tr>
<th>Returned Value</th>
<th>Response type</th>
</tr></thead>
<tbody>
<tr>
<td>String</td>
<td>text/plain</td>
</tr>
<tr>
<td>Map or List</td>
<td>application/json</td>
</tr>
<tr>
<td>File</td>
<td>(MimeType of the file)</td>
</tr>
</tbody>
</table><p>If a Future is returned, then the framework will wait for its completion. </p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="n">helloWorld</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">Future</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="s2">"Hello, World!"</span><span class="p">);</span>
</pre></div>

<p>For other types, bloodless will convert the value to a String, and send it as <em>text/plain</em>.</p>

<p>Also, it's possible to override the content type of the response:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="nl">responseType:</span> <span class="s2">"text/xml"</span><span class="p">)</span>
<span class="n">getXml</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">"&lt;root&gt;&lt;node&gt;text&lt;/node&gt;&lt;/root&gt;"</span><span class="p">;</span>
</pre></div>

<h3>
<a name="retrieving-path-parameters" class="anchor" href="#retrieving-path-parameters"><span class="octicon octicon-link"></span></a>Retrieving path parameters</h3>

<p>You can easily bind URL parts to arguments:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/user/:username"</span><span class="p">)</span>
<span class="n">helloUser</span><span class="p">(</span><span class="kt">String</span> <span class="n">username</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">"hello </span><span class="si">$</span><span class="n">username</span><span class="s2">"</span><span class="p">;</span>
</pre></div>

<p>The argument doesn't need to be a String. If it's an int, for example, bloodless will try to convert the value for you (if the conversion fails, a 400 status code is sent to the client).</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/user/:username/:addressId"</span><span class="p">)</span>
<span class="n">getAddress</span><span class="p">(</span><span class="kt">String</span> <span class="n">username</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addressId</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<p>The supported types are: int, double and bool</p>

<h3>
<a name="retrieving-query-parameters" class="anchor" href="#retrieving-query-parameters"><span class="octicon octicon-link"></span></a>Retrieving query parameters</h3>

<p>Use the <code>QueryParam</code> annotation to access a query parameter</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/user"</span><span class="p">)</span>
<span class="n">getUser</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">QueryParam</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span> <span class="kt">int</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<p>Like path parameters, the argument doesn't need to be a String. </p>

<h3>
<a name="http-methods" class="anchor" href="#http-methods"><span class="octicon octicon-link"></span></a>HTTP Methods</h3>

<p>By default, a route only respond to GET requests. You can change that with the <code>methods</code> arguments:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/user/:username"</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">])</span>
<span class="n">helloUser</span><span class="p">(</span><span class="kt">String</span> <span class="n">username</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">"hello </span><span class="si">$</span><span class="n">username</span><span class="s2">"</span><span class="p">;</span>
</pre></div>

<h3>
<a name="retrieving-the-request-body" class="anchor" href="#retrieving-the-request-body"><span class="octicon octicon-link"></span></a>Retrieving the request body</h3>

<p>You can retrieve the request body as a form, json or text</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/adduser"</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">])</span>
<span class="n">addUser</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Body</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">JSON</span><span class="p">)</span> <span class="n">Map</span> <span class="n">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/adduser"</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">])</span>
<span class="n">addUser</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Body</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">FORM</span><span class="p">)</span> <span class="n">Map</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<h4>
<a name="multipart-requests-file-uploads" class="anchor" href="#multipart-requests-file-uploads"><span class="octicon octicon-link"></span></a>Multipart requests (file uploads)</h4>

<p>By default, Bloodless will refuse any multipart request. If your method need to receive a multipart request, you can set <code>Route.allowMultipartRequest = true</code>. Example:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/adduser"</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">],</span> <span class="nl">allowMultipartRequest:</span> <span class="kc">true</span><span class="p">)</span>
<span class="n">addUser</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Body</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">FORM</span><span class="p">)</span> <span class="n">Map</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<h3>
<a name="the-request-object" class="anchor" href="#the-request-object"><span class="octicon octicon-link"></span></a>The request object</h3>

<p>You can use the global <code>request</code> object to access the request's information and content:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/user"</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">])</span>
<span class="n">user</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">app</span><span class="p">.</span><span class="n">GET</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">bodyType</span> <span class="o">==</span> <span class="n">app</span><span class="p">.</span><span class="n">JSON</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="n">json</span> <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">;</span>
      <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>

<p>Actually, the <code>request</code> object is a get method, that retrieves the request object from the current Zone. Since each request runs in its own zone, it's completely safe to use <code>request</code> at any time, even in async callbacks.</p>

<h2>
<a name="interceptors" class="anchor" href="#interceptors"><span class="octicon octicon-link"></span></a>Interceptors</h2>

<p>Each request is actually a chain, composed by 0 or more interceptors, and a target. A target is a method annotated with <code>Route</code>, or a static file handled by a VirtualDirectory instance. An interceptor is a structure that allows you to apply a common behaviour to a group of targets. For example, you can use a interceptor to change the response of a group of targets, or to apply a security constraint.</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/.*'</span><span class="p">)</span>
<span class="n">handleResponseHeader</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"Access-Control-Allow-Origin"</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">);</span>
  <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/admin/.*'</span><span class="p">)</span>
<span class="n">adminFilter</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">session</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">interrupt</span><span class="p">(</span><span class="nl">statusCode:</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">UNAUTHORIZED</span><span class="p">);</span>
    <span class="c1">//or app.redirect("/login.html");</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>When a request is received, the framework will execute all interceptors that matchs the URL, and then will look for a valid route. If a route is found, it will be executed, otherwise the request will be fowarded to the VirtualDirectory, which will look for a static file.</p>

<p>Each interceptor must call the <code>chain.next()</code> or <code>chain.interrupt()</code> methods, otherwise, the request will be stucked. The <code>chain.next()</code> method can receive a callback, that is executed when the target completes. All callbacks are executed in the reverse order they are created. If a callback returns a <code>Future</code>, then the next callback will execute only when the future completes.</p>

<p>For example, consider this script:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="n">helloWorld</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">"target</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/.*'</span><span class="p">,</span> <span class="nl">chainIdx:</span> <span class="m">0</span><span class="p">)</span>
<span class="n">interceptor1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"interceptor 1 - before target</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
  <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"interceptor 1 - after target</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/.*'</span><span class="p">,</span> <span class="nl">chainIdx:</span> <span class="m">1</span><span class="p">)</span>
<span class="n">interceptor2</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"interceptor 2 - before target</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
  <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"interceptor 2 - after target</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">app</span><span class="p">.</span><span class="n">setupConsoleLog</span><span class="p">();</span>
  <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>

<p>When you access <a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a>, the result is:</p>

<pre><code>interceptor 1 - before target
interceptor 2 - before target
target
interceptor 2 - after target
interceptor 1 - after target
</code></pre>

<p>Like the <code>request</code> object, the <code>chain</code> object is also a get method, that returns the chain of the current zone.</p>

<p><strong>NOTE: By default, Bloodless won't parse the request body until all interceptors are called. If your interceptor need to inspect the request body, you must set <code>parseRequestBody = true</code>. Example:</strong></p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/service/.+'</span><span class="p">,</span> <span class="nl">parseRequestBody:</span> <span class="kc">true</span><span class="p">)</span>
<span class="n">verifyRequest</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//if parseRequestBody is not setted, request.body is null</span>
  <span class="n">print</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
  <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
<span class="p">}</span>

</pre></div>

<p><strong>NOTE: You can also call <code>redirect()</code> or <code>abort()</code> instead of <code>chain.interrupt()</code>. The <code>abort()</code> call will invoke the corresponding error handler.</strong></p>

<h2>
<a name="request-attributes" class="anchor" href="#request-attributes"><span class="octicon octicon-link"></span></a>Request attributes</h2>

<p>Request attributes are objects that can be shared between interceptors and targets. They can be accessed through the <code>request.attributes</code> map. Also, if your method is annotated with <code>@Route</code>, they can be injected using the <code>Attr</code> annotation. Example:</p>

<div class="highlight highlight-Dart"><pre>
<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/services/.+'</span><span class="p">)</span>
<span class="n">dbConnInterceptor</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DbConn</span><span class="p">();</span>
  <span class="n">app</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">"dbConn"</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
  <span class="n">app</span><span class="p">.</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">());</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s1">'/services/find'</span><span class="p">)</span>
<span class="n">find</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Attr</span><span class="p">()</span> <span class="n">dbConn</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>

</pre></div>

<h2>
<a name="groups" class="anchor" href="#groups"><span class="octicon octicon-link"></span></a>Groups</h2>

<p>You can use classes to group routes and interceptors:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">Group</span><span class="p">(</span><span class="s2">"/user"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">UserService</span> <span class="p">{</span>

  <span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/find"</span><span class="p">)</span>
  <span class="n">findUser</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">QueryParam</span><span class="p">(</span><span class="s2">"n"</span><span class="p">)</span> <span class="kt">String</span> <span class="n">name</span><span class="p">,</span>
           <span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">QueryParam</span><span class="p">(</span><span class="s2">"c"</span><span class="p">)</span> <span class="kt">String</span> <span class="n">city</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/add"</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">])</span>
  <span class="n">addUser</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Body</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">JSON</span><span class="p">)</span> <span class="n">Map</span> <span class="n">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The prefix defined with the <code>Group</code> annotation, will be prepended in every route and interceptor inside the group.</p>

<h2>
<a name="error-handlers" class="anchor" href="#error-handlers"><span class="octicon octicon-link"></span></a>Error handlers</h2>

<p>You can define error handlers with the <code>ErrorHandler</code> annotation:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">ErrorHandler</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
<span class="n">handleNotFoundError</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">redirect</span><span class="p">(</span><span class="s2">"/error/not_found.html"</span><span class="p">);</span>
</pre></div>

<p>Also, you can define a error handler for a specific urlPattern</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">ErrorHandler</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="n">NOT_FOUND</span><span class="p">,</span> <span class="nl">urlPattern:</span> <span class="s1">r'/public/.+'</span><span class="p">)</span>
<span class="n">handleNotFoundError</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">redirect</span><span class="p">(</span><span class="s2">"/error/not_found.html"</span><span class="p">);</span>
</pre></div>

<p>If you define a error handler inside a group, then the handler will be restricted to the group path.</p>

<p><strong>NOTE: If a target throws a error, it can be accessed through the <code>chain.error</code> getter.</strong></p>

<h2>
<a name="dependency-injection" class="anchor" href="#dependency-injection"><span class="octicon octicon-link"></span></a>Dependency injection</h2>

<p>Bloodless uses the <a href="http://pub.dartlang.org/packages/di">di package</a> to provide dependency injection.</p>

<p>To register a module, use the <code>addModule()</code> method:</p>

<div class="highlight highlight-Dart"><pre><span class="k">import</span> <span class="s1">'package:bloodless/server.dart'</span> <span class="k">as</span> <span class="n">app</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'package:di/di.dart'</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">app</span><span class="p">.</span><span class="n">addModule</span><span class="p">(</span><span class="k">new</span> <span class="n">Module</span><span class="p">()</span>
       <span class="p">..</span><span class="n">bind</span><span class="p">(</span><span class="n">ClassA</span><span class="p">)</span>
       <span class="p">..</span><span class="n">bind</span><span class="p">(</span><span class="n">ClassB</span><span class="p">));</span>

  <span class="n">app</span><span class="p">.</span><span class="n">setupConsoleLog</span><span class="p">();</span>
  <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="p">}</span>

</pre></div>

<p>For methods annotated with <code>@Route</code>, you can inject objects using the <code>@Inject</code> annotation:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s1">'/service'</span><span class="p">)</span>
<span class="n">service</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Inject</span><span class="p">()</span> <span class="n">ClassA</span> <span class="n">objA</span><span class="p">)</span> <span class="p">{</span>
 <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<p>Groups can require objects using a constructor:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Group</span><span class="p">(</span><span class="s1">'/group'</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">Group</span> <span class="p">{</span>

  <span class="n">ClassA</span> <span class="n">objA</span><span class="p">;</span>

  <span class="n">Group</span><span class="p">(</span><span class="n">ClassA</span> <span class="k">this</span><span class="p">.</span><span class="n">objA</span><span class="p">);</span>

  <span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s1">'/service'</span><span class="p">)</span>
  <span class="n">service</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<p>Interceptors and error handlers can also require dependencies:</p>

<div class="highlight highlight-Dart"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">(</span><span class="s1">r'/services/.+'</span><span class="p">)</span>
<span class="n">interceptor</span><span class="p">(</span><span class="n">ClassA</span> <span class="n">objA</span><span class="p">,</span> <span class="n">ClassB</span> <span class="n">objB</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>


<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">ErrorHandler</span><span class="p">(</span><span class="m">404</span><span class="p">)</span>
<span class="n">notFound</span><span class="p">(</span><span class="n">ClassB</span> <span class="n">objB</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="server-configuration" class="anchor" href="#server-configuration"><span class="octicon octicon-link"></span></a>Server configuration</h2>

<p>If you invoke the <code>start()</code> method with no arguments, the server will be configured with default values:</p>

<table>
<thead><tr>
<th>Argument</th>
<th>Default Value</th>
</tr></thead>
<tbody>
<tr>
<td>host</td>
<td>"0.0.0.0"</td>
</tr>
<tr>
<td>port</td>
<td>8080</td>
</tr>
<tr>
<td>staticDir</td>
<td>"../web"</td>
</tr>
<tr>
<td>indexFiles</td>
<td>["index.html"]</td>
</tr>
<tr>
<td>followLinks</td>
<td>false</td>
</tr>
<tr>
<td>jailRoot</td>
<td>true</td>
</tr>
</tbody>
</table><p><strong>NOTE: During development, you will probably need to set <code>followLinks = true</code> and <code>jailRoot = false</code>, since Dartium will request for .dart files that are not in web folder. Although, doing so in production environment can lead to security issues.</strong></p>

<h2>
<a name="logging" class="anchor" href="#logging"><span class="octicon octicon-link"></span></a>Logging</h2>

<p>Bloodless provides a helper method to set a simple log handler, that outputs the messages to the console:</p>

<div class="highlight highlight-Dart"><pre><span class="n">app</span><span class="p">.</span><span class="n">setupConsoleLog</span><span class="p">();</span>
</pre></div>

<p>By default, the log level is setted to INFO, which logs the startup process and errors. If you want to see all the log messages, you can set the level to ALL:</p>

<div class="highlight highlight-Dart"><pre><span class="k">import</span> <span class="s1">'package:logging/logging.dart'</span><span class="p">;</span>


<span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">app</span><span class="p">.</span><span class="n">setupConsoleLog</span><span class="p">(</span><span class="n">Level</span><span class="p">.</span><span class="n">ALL</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<p>If you want to output the messages to a different place (for example, a file), you can define your own log handler:</p>

<div class="highlight highlight-Dart"><pre><span class="n">Logger</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">Level</span><span class="p">.</span><span class="n">ALL</span><span class="p">;</span>
<span class="n">Logger</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">onRecord</span><span class="p">.</span><span class="n">listen</span><span class="p">((</span><span class="n">LogRecord</span> <span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="unit-tests" class="anchor" href="#unit-tests"><span class="octicon octicon-link"></span></a>Unit tests</h2>

<p>Bloodless provides a simple API that you can use to easily test your server. </p>

<p>For example, consider you have the following service at <code>/lib/services.dart</code></p>

<div class="highlight highlight-Dart"><pre><span class="k">library</span> <span class="n">services</span><span class="p">;</span>

<span class="k">import</span> <span class="s1">'package:bloodless/server.dart'</span> <span class="k">as</span> <span class="n">app</span><span class="p">;</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">"/user/:username"</span><span class="p">)</span>
<span class="n">helloUser</span><span class="p">(</span><span class="kt">String</span> <span class="n">username</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">"hello, </span><span class="si">$</span><span class="n">username</span><span class="s2">"</span><span class="p">;</span>
</pre></div>

<p>A simple script to test this service would be:</p>

<div class="highlight highlight-Dart"><pre><span class="k">import</span> <span class="s1">'package:unittest/unittest.dart'</span><span class="p">;</span>

<span class="k">import</span> <span class="s1">'package:bloodless/server.dart'</span> <span class="k">as</span> <span class="n">app</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'package:bloodless/mocks.dart'</span><span class="p">;</span>

<span class="k">import</span> <span class="s1">'package:your_package_name/services.dart'</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">//load the services in 'services' library</span>
  <span class="n">setUp</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">setUp</span><span class="p">([</span><span class="err">#</span><span class="n">services</span><span class="p">]);</span>

  <span class="c1">//remove all loaded services</span>
  <span class="n">tearDown</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">tearDown</span><span class="p">());</span>

  <span class="n">test</span><span class="p">(</span><span class="s2">"hello service"</span><span class="p">,</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">//create a mock request</span>
    <span class="kd">var</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MockRequest</span><span class="p">(</span><span class="s2">"/user/luiz"</span><span class="p">);</span>
    <span class="c1">//dispatch the request</span>
    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">req</span><span class="p">).</span><span class="n">then</span><span class="p">((</span><span class="n">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//verify the response</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">statusCode</span><span class="p">,</span> <span class="n">equals</span><span class="p">(</span><span class="m">200</span><span class="p">));</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">mockContent</span><span class="p">,</span> <span class="n">equals</span><span class="p">(</span><span class="s2">"hello, luiz"</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">})</span>

<span class="p">}</span>
</pre></div>

<p><strong>NOTE: To learn more about unit tests in Dart, take a look at <a href="https://www.dartlang.org/articles/dart-unit-tests/">this article</a>.</strong></p>

<h2>
<a name="deploying-the-app" class="anchor" href="#deploying-the-app"><span class="octicon octicon-link"></span></a>Deploying the app</h2>

<p>The easiest way to build your app is using the <a href="http://pub.dartlang.org/packages/grinder">grinder</a> library. Bloodless provides a simples task to properly copy the server's files to the build folder, which you can use in your build script. For example:</p>

<ul>
<li>Create a <code>build.dart</code> file inside the <code>bin</code> folder</li>
</ul><div class="highlight highlight-Dart"><pre><span class="k">import</span> <span class="s1">'package:grinder/grinder.dart'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'package:grinder/grinder_utils.dart'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'package:bloodless/tasks.dart'</span><span class="p">;</span>

<span class="n">main</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">defineTask</span><span class="p">(</span><span class="s1">'build'</span><span class="p">,</span> <span class="nl">taskFunction:</span> <span class="p">(</span><span class="n">GrinderContext</span> <span class="n">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">PubTools</span><span class="p">().</span><span class="n">build</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
  <span class="n">defineTask</span><span class="p">(</span><span class="s1">'deploy_server'</span><span class="p">,</span> <span class="nl">taskFunction:</span> <span class="n">deployServer</span><span class="p">,</span> <span class="nl">depends:</span> <span class="p">[</span><span class="s1">'build'</span><span class="p">]);</span>
  <span class="n">defineTask</span><span class="p">(</span><span class="s1">'all'</span><span class="p">,</span> <span class="nl">depends:</span> <span class="p">[</span><span class="s1">'build'</span><span class="p">,</span> <span class="s1">'deploy_server'</span><span class="p">]);</span>

  <span class="n">startGrinder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<ul>
<li><p>Instead of running <code>pub build</code> directly, you can call <code>build.dart</code> to properly build your app.</p></li>
<li><p>To run <code>build.dart</code> through Dart Editor, you need to create a command-line launch configuration, with the following parameters:</p></li>
</ul><table>
<thead><tr>
<th>Parameter</th>
<th>Value</th>
</tr></thead>
<tbody>
<tr>
<td>Dart Script</td>
<td>bin/build.dart</td>
</tr>
<tr>
<td>Working directory</td>
<td>(root path of your project)</td>
</tr>
<tr>
<td>Script arguments</td>
<td>all</td>
</tr>
</tbody>
</table><ul>
<li>To run <code>build.dart</code> through command line, you need to set the DART_SDK environment variable:</li>
</ul><pre><code>$ export DART_SDK=(path to dart-sdk)
$ dart bin/build.dart all
</code></pre>

<p><strong>NOTE: You can improve your build script according to your needs.</strong></p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/luizmineo">luizmineo</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-50600290-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>